<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>株式指標トラッカー</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js" defer></script>
    <script src="app.js" defer></script>
  </head>
  <body>
    <header>
      <div class="header-inner">
        <h1>株式指標トラッカー</h1>
        <p>株価は日次で入力、EPSは会計・予想データとして管理し、PER（株価 ÷ EPS）を自動記録します。</p>
      </div>
    </header>

    <main>
      <section class="card">
        <h2>銘柄登録</h2>
        <form id="stock-form" class="grid-form">
          <label>
            銘柄コード
            <input id="ticker" name="ticker" required placeholder="例: 7203" />
          </label>
          <label>
            銘柄名
            <input id="stock-name" name="name" required placeholder="例: トヨタ自動車" />
          </label>
          <button type="submit">銘柄を追加</button>
        </form>
        <div id="stock-list" class="chip-list"></div>
      </section>

      <section class="card">
        <h2>EPSモード設定（PERの分母）</h2>
        <p class="hint">PER は <strong>株価 ÷ EPS</strong>。EPSは日次で変えず、モードに応じて管理します。</p>
        <form id="eps-form" class="grid-form">
          <label>
            銘柄
            <select id="eps-ticker" required></select>
          </label>
          <label>
            EPSモード
            <select id="eps-mode" required>
              <option value="FIXED_EPS">固定EPS（FIXED_EPS）</option>
              <option value="QUARTERLY_EPS">四半期EPS（QUARTERLY_EPS）</option>
              <option value="FORWARD_EPS">予想EPS（FORWARD_EPS）</option>
            </select>
          </label>

          <label id="fixed-wrap">
            固定EPS
            <input id="fixed-eps" type="number" step="0.01" />
          </label>

          <label id="forward-wrap" class="hidden">
            予想EPS
            <input id="forward-eps" type="number" step="0.01" />
          </label>

          <div id="quarterly-wrap" class="full hidden">
            <p class="hint">四半期EPSを追加すると、直近4四半期合計（TTM EPS）を自動算出します。</p>
            <div class="grid-form">
              <label>
                四半期
                <input id="quarter-label" placeholder="例: 2025Q4" />
              </label>
              <label>
                四半期EPS
                <input id="quarter-eps" type="number" step="0.01" />
              </label>
              <button id="add-quarter" type="button">四半期EPSを追加/更新</button>
            </div>
            <div id="quarter-list" class="mini-list"></div>
          </div>

          <button type="submit">EPS設定を保存</button>
        </form>
        <p id="eps-summary" class="hint"></p>
      </section>

      <section class="card">
        <h2>日次株価を記録（PER自動計算）</h2>
        <form id="record-form" class="grid-form">
          <label>
            銘柄
            <select id="record-ticker" required></select>
          </label>
          <label>
            日付
            <input id="record-date" type="date" required />
          </label>
          <label>
            株価
            <input id="price" type="number" step="0.01" min="0" required />
          </label>
          <label>
            使用EPS（自動）
            <input id="resolved-eps" readonly />
          </label>
          <label>
            PER（自動）
            <input id="resolved-per" readonly />
          </label>
          <label class="full">
            メモ
            <textarea id="memo" rows="2" placeholder="決算補足など"></textarea>
          </label>
          <button type="submit">日次データを保存</button>
        </form>
      </section>

      <section class="card">
        <h2>画像から株価を補助入力（任意）</h2>
        <p class="hint">数字の誤認識を減らすため、全角数字・カンマ・改行ゆれを自動補正して抽出します。</p>
        <div class="grid-form">
          <label class="full">
            画像アップロード
            <input id="ocr-image" type="file" accept="image/*" />
          </label>
          <button id="ocr-run" type="button">画像を読み取って株価へ反映</button>
          <p id="ocr-status" class="hint"></p>
        </div>
      </section>

      <section class="card">
        <h2>日次PER推移</h2>
        <div class="toolbar">
          <label>
            銘柄で絞り込み
            <select id="filter-ticker">
              <option value="all">すべて</option>
            </select>
          </label>
          <button id="export-json" type="button">JSONエクスポート</button>
          <label class="import-btn">
            JSONインポート
            <input id="import-json" type="file" accept="application/json" hidden />
          </label>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>日付</th>
                <th>銘柄</th>
                <th>株価</th>
                <th>EPSモード</th>
                <th>使用EPS</th>
                <th>PER</th>
                <th>メモ</th>
                <th>削除</th>
              </tr>
            </thead>
            <tbody id="records-body"></tbody>
          </table>
        </div>

        <canvas id="per-chart" height="120"></canvas>
      </section>
    </main>
  </body>
</html>
